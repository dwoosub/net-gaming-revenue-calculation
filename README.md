# Net Gaming Revenue (NGR) Calculation – Casino Player Performance

## 1. Overview
This repository demonstrates how **Net Gaming Revenue (NGR)** is calculated at a **daily, per-player level** for casino users on the platform.

The pipeline consolidates **session-level gameplay data**, **promotional redemptions**, and **tournament payouts** into a single **Snowflake Dynamic Table**, enabling accurate profitability analysis by player, game category, brand, and site.

This table serves as a **single source of truth for player-level profitability**, supporting casino operations, CRM, and finance teams with **real-time, revenue-aware decision-making**.

---

## 2. What is NGR?
**Net Gaming Revenue (NGR)** represents the *true revenue* generated by a player after accounting for promotional and tournament-related costs.

**Formula**
```
NGR = GGR − Redeemed Promotions − Tournament Cash Prizes
```

This metric is critical for:
- Player profitability analysis
- CRM and promotion optimization
- Lifetime Value (LTV) modeling
- Finance and regulatory reporting

---

## 3. Data Architecture

### Source Systems
- **Gameplay Sessions:** Casino bets, wins, GGR, Theo Win
- **Promotions:** Cash rewards, casino bonuses (promotional credits), free spins, third-party rewards
- **Tournaments:** Cash prizes paid to players
- **Player Metadata:** Region, brand, site, player identifiers

---

## 4. Dynamic Table Design

The core output is a **Snowflake Dynamic Table** that automatically refreshes and produces **daily player-level NGR metrics**.

```sql
CREATE OR REPLACE DYNAMIC TABLE DW_CP.PUBLIC.NGR_DAILY_PLAYER_PERFORMANCE
TARGET_LAG = '1 hour'
REFRESH_MODE = AUTO
INITIALIZE = ON_SCHEDULE
WAREHOUSE = DT_CP_WH
AS
...
```

This design ensures:
- Near real-time data availability
- Automatic refresh and dependency management
- No manual backfills or orchestration overhead
- Consistent metrics across downstream consumers

---

## 5. Key Transformation Steps

### Step 1: Player Region Resolution
Players may change regions over time. The most recent region is resolved using a window function to ensure accurate attribution.

```sql
ROW_NUMBER() OVER (PARTITION BY GPID ORDER BY CREATEDAT DESC)
```

---

### Step 2: Session-Level Gameplay Metrics
Casino session data is normalized into USD and enriched with **Theo Win**, using the most recent RTP per game.

```sql
THEO_WIN = BET * (1 - GAME_RTP)
```

Captured metrics include:
- Total bets and bet counts
- GGR and Theo Win
- Slot, Casino, and Live Dealer performance breakdowns

---

### Step 3: Promotion Cost Attribution
Promotion data is unified across **global** and **regional (WSOP)** systems and categorized into granular cost buckets, including:

- Cash rewards
- Casino bonuses (CRM, TPM, promotional credits)
- Free spins
- Free chips
- Third-party provider rewards
- Tournament-related bonuses

This structure enables **precise cost attribution** for every dollar deducted from revenue.

---

### Step 4: Tournament Cash Prizes
Tournament winnings are treated separately from promotions and deducted directly from revenue to reflect true profitability.

```sql
TNMT_CASH_PRIZE
```

---

### Step 5: Daily Player Aggregation
Gameplay, promotions, and tournament payouts are **FULL OUTER JOINed** to guarantee completeness:

- Players with promotions but no gameplay are included
- Players with gameplay but no promotions are included

All missing values are safely defaulted to zero using `COALESCE`.

---

## 6. Final NGR Calculation

The final Net Gaming Revenue is calculated directly in the output layer:

```sql
-- NGR Calculation
GGR 
- REDEEMED_AMOUNT 
- TNMT_CASH_PRIZE AS NGR
```

This produces a **clean, auditable, finance-ready NGR metric** per:
- Player
- Day
- Brand
- Site

---

## 7. Output Metrics

Each row represents **one player on one day**, including:

### Gameplay
- BET, BET_COUNT
- GGR, THEO_WIN
- Slot / Casino / Live Dealer splits

### Promotions
- Total redeemed amount
- Cash vs casino bonus (promotional credits) vs free spin costs
- CRM vs TPM vs third-party attribution

### Profitability
- **Net Gaming Revenue (NGR)**

---

## 8. Business Use Cases
- Player profitability and cohort analysis
- Casino bonus ROI and CRM targeting using true net revenue signals
- Identification of unprofitable players and promotion leakage
- LTV modeling inputs
- Finance and regulatory reporting
- Executive-level performance monitoring by brand and site

---

## 9. Tools & Technologies
- **Snowflake Dynamic Tables**
- **Advanced SQL (CTEs, Window Functions)**
- **Casino Gaming Analytics**
- **Revenue and Promotion Cost Modeling**

---

## 10. Technical Highlights
- Production-grade Snowflake Dynamic Tables
- Complex multi-source joins with data completeness guarantees
- Robust handling of missing data via FULL OUTER JOIN and COALESCE
- Financially auditable revenue calculations
- Scalable daily, player-level aggregation
